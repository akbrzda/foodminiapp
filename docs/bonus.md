# Полная документация модуля системы лояльности

## Оглавление

1. [Общая информация](#1-общая-информация)
2. [Текущее состояние системы](#2-текущее-состояние-системы)
3. [Цели доработки](#3-цели-доработки)
4. [Архитектура базы данных](#4-архитектура-базы-данных)
5. [Бизнес-правила и логика](#5-бизнес-правила-и-логика)
6. [Сценарии использования](#6-сценарии-использования)
7. [Настройки системы](#7-настройки-системы)
8. [Административные функции](#8-административные-функции)
9. [Интеграция с заказами](#9-интеграция-с-заказами)
10. [Автоматические процессы](#10-автоматические-процессы)
11. [Отчетность и аудит](#11-отчетность-и-аудит)
12. [План доработки](#12-план-доработки)
13. [Приложения](#13-приложения)

---

## 1. Общая информация

### 1.1 Назначение модуля

Модуль системы лояльности - это комплексная система управления бонусами, которая предназначена для:

- **Мотивации клиентов** - стимулирование повторных покупок через накопление и использование бонусов
- **Сегментации клиентов** - разделение на уровни с разными условиями
- **Автоматизации маркетинга** - автоматические начисления за ключевые события
- **Увеличения LTV** - повышение lifetime value через программу лояльности
- **Аналитики поведения** - сбор данных о покупательской активности

### 1.2 Основные принципы работы

**Трехуровневая система:**
- **Уровень 1 (Бронза)** - начальный уровень для всех пользователей (3% начисления)
- **Уровень 2 (Серебро)** - промежуточный уровень (5% начисления, порог 10,000₽)
- **Уровень 3 (Золото)** - максимальный уровень (7% начисления, порог 20,000₽)

**Динамика уровней:**
- Автоматическое повышение при достижении суммы заказов за 60 дней
- Автоматическое понижение при отсутствии заказов 6 месяцев
- Постепенное понижение (на 1 уровень за раз)

**Конвертация бонусов:**
- 1 бонус = 1 рубль скидки
- Максимальное списание 30% от суммы заказа
- Бонусы нельзя вывести или передать

**Жизненный цикл бонусов:**
- Начисление после успешного завершения заказа
- Срок действия 60 дней (регистрационные - 30 дней, ДР - 11 дней)
- Автоматическое списание при истечении
- FIFO принцип использования (первыми списываются те, что скоро истекут)

---

## 2. Текущее состояние системы

### 2.1 Что уже реализовано

В системе уже работает базовая программа лояльности:

**Функционал:**
- ✅ Начисление бонусов за завершенные заказы
- ✅ Списание бонусов при оформлении заказа
- ✅ Трехуровневая система (Бронза, Серебро, Золото)
- ✅ Хранение баланса пользователя
- ✅ История транзакций

**Структура данных:**
- Таблица `users` с полем `bonus_balance`
- Таблица `loyalty_transactions` для истории
- Привязка транзакций к заказам

**Логика:**
- Начисление происходит при статусе "Доставлен"/"Выдан"
- Списание происходит при создании заказа
- Процент начисления зависит от уровня пользователя

### 2.2 Выявленные проблемы

**Критические баги:**

1. **Дублирование бонусов**
   - При повторной смене статуса заказа бонусы начисляются/списываются повторно
   - Нет проверки на существующие транзакции по заказу
   - Приводит к неконтролируемому росту балансов

2. **Race conditions**
   - При одновременном создании 2+ заказов одним пользователем
   - Возможно списание одних и тех же бонусов несколько раз
   - Баланс может уйти в отрицательное значение

3. **Некорректная обработка отмен**
   - При отмене заказа бонусы не всегда возвращаются
   - При отмене после доставки начисленные бонусы не отменяются
   - Нет обработки частичной отмены (удаление позиций)

4. **Отсутствие истечения**
   - Бонусы хранятся бесконечно
   - Нет автоматического списания по истечении срока
   - Растут "мертвые" балансы

5. **Нет истории уровней**
   - Невозможно отследить когда менялся уровень
   - Нет информации почему произошло изменение
   - Отсутствует аудит переходов

**Функциональные ограничения:**

1. **Жесткая конфигурация**
   - Проценты начисления захардкожены в коде
   - Пороги уровней нельзя изменить
   - Сроки действия фиксированные

2. **Нет администрирования**
   - Невозможно изменить настройки без правки кода
   - Нет интерфейса управления уровнями
   - Отсутствуют инструменты просмотра данных

3. **Отсутствие автоматизации**
   - Нет бонуса за регистрацию
   - Нет бонуса за день рождения
   - Нет автоматической деградации уровней

4. **Нет аудита**
   - Сложно найти дубли начислений
   - Нет инструментов поиска ошибок
   - Отсутствует логирование событий

5. **Проблемы с производительностью**
   - Баланс считается каждый раз из транзакций
   - Нет кеширования
   - Медленные запросы при большом количестве транзакций

### 2.3 Необходимые доработки

Модуль требует комплексной доработки по следующим направлениям:

**1. Устранение багов (критично)**
- Защита от дублирования транзакций
- Защита от race conditions
- Корректная обработка всех сценариев отмены
- Атомарность операций с балансом

**2. Добавление гибкости**
- Все настройки в админ-панели
- Управление уровнями через интерфейс
- Возможность включения/отключения модуля
- Настройка правил начисления и списания

**3. Автоматизация**
- Истечение бонусов
- Деградация уровней
- Автоматические начисления
- Сверка балансов

**4. Инструменты аудита**
- Поиск дублей
- Поиск расхождений
- Логирование событий
- Отчеты и статистика

**5. Оптимизация**
- Денормализация для скорости
- Кеширование балансов
- Правильные индексы
- Батчевая обработка

---

## 3. Цели доработки

### 3.1 Бизнес-цели

**Надежность:**
- Устранить все критические баги
- Гарантировать корректность балансов
- Обеспечить прозрачность операций
- Исключить потерю бонусов

**Гибкость:**
- Управление через интерфейс
- Быстрая адаптация под бизнес-задачи
- Возможность экспериментов с условиями
- Масштабируемость системы

**Автоматизация:**
- Минимум ручной работы
- Автоматическое обслуживание
- Самопроверка и самовосстановление
- Проактивное обнаружение проблем

### 3.2 Технические цели

**Архитектура:**
- Чистое разделение ответственности
- Модульность и расширяемость
- Понятная структура данных
- Документированность

**Производительность:**
- Быстрый доступ к балансам
- Эффективные запросы
- Минимальная нагрузка на БД
- Масштабируемость

**Надежность:**
- Транзакционность операций
- Защита от ошибок
- Логирование и мониторинг
- Возможность отката

### 3.3 Ожидаемые результаты

После завершения доработки:

**Для бизнеса:**
- Стабильная работа без ошибок
- Полный контроль над программой
- Инструменты аналитики
- Гибкость настройки

**Для пользователей:**
- Прозрачная система
- Понятные правила
- Дополнительные бонусы
- Мотивация к покупкам

**Для команды:**
- Удобные инструменты администрирования
- Быстрая диагностика проблем
- Минимум поддержки
- Масштабируемость

---

## 4. Архитектура базы данных

### 4.1 Обзор структуры

Система лояльности использует 7 таблиц:

1. **loyalty_settings** - глобальные настройки (1 запись)
2. **loyalty_levels** - уровни лояльности (3-5 записей)
3. **loyalty_transactions** - история операций (растет постоянно)
4. **user_loyalty_levels** - история уровней пользователей
5. **user_loyalty_stats** - агрегированная статистика (денормализация)
6. **loyalty_logs** - логи системы
7. **users** - дополнительные поля

### 4.2 Таблица loyalty_settings

**Назначение:** Хранение всех глобальных настроек программы лояльности.

**Поля:**

| Поле | Тип | По умолчанию | Описание |
|------|-----|--------------|----------|
| id | INT | - | Первичный ключ (всегда = 1) |
| is_enabled | BOOLEAN | TRUE | Включена ли программа |
| max_spend_percent | INT | 30 | Максимальный % списания |
| include_delivery_in_earn | BOOLEAN | FALSE | Учитывать доставку при начислении |
| calculate_from_amount_after_bonus | BOOLEAN | TRUE | Начислять от суммы после вычета бонусов |
| level_calculation_period_days | INT | 60 | Период для расчета уровня |
| level_calculation_include_delivery | BOOLEAN | FALSE | Учитывать доставку для уровня |
| level_degradation_enabled | BOOLEAN | TRUE | Включена ли деградация |
| level_degradation_period_days | INT | 180 | Период без заказов для понижения |
| registration_bonus_enabled | BOOLEAN | TRUE | Бонус за регистрацию |
| registration_bonus_amount | INT | 1000 | Количество бонусов |
| registration_bonus_expires_days | INT | 30 | Срок действия рег. бонусов |
| birthday_bonus_enabled | BOOLEAN | TRUE | Бонус за ДР |
| birthday_bonus_amount | INT | 500 | Количество бонусов за ДР |
| birthday_bonus_days_before | INT | 3 | За сколько дней до ДР |
| birthday_bonus_days_after | INT | 7 | Срок после ДР |
| default_bonus_expires_days | INT | 60 | Срок действия обычных бонусов |
| created_at | DATETIME | NOW | Дата создания |
| updated_at | DATETIME | NOW | Дата обновления |

**Особенности:**
- Всегда только одна запись (id = 1)
- Изменения через UPDATE
- Кешируется на 1 час

### 4.3 Таблица loyalty_levels

**Назначение:** Настройки уровней программы лояльности.

**Поля:**

| Поле | Тип | Описание |
|------|-----|----------|
| id | INT | Первичный ключ |
| name | VARCHAR(50) | Название (Бронза, Серебро, Золото) |
| level_number | INT | Порядковый номер (1, 2, 3) |
| threshold_amount | INT | Порог достижения (в рублях) |
| earn_percent | DECIMAL(5,2) | Процент начисления (3.00, 5.00, 7.00) |
| max_spend_percent | INT | Максимальный % списания |
| is_active | BOOLEAN | Активен ли уровень |
| sort_order | INT | Порядок сортировки |
| created_at | DATETIME | Дата создания |
| updated_at | DATETIME | Дата обновления |

**Индексы:**
- PRIMARY KEY (id)
- UNIQUE KEY (level_number)
- INDEX (threshold_amount)

**Значения по умолчанию:**

| Название | Номер | Порог | % начисления | % списания |
|----------|-------|-------|--------------|------------|
| Бронза | 1 | 0₽ | 3% | 20% |
| Серебро | 2 | 10,000₽ | 5% | 25% |
| Золото | 3 | 20,000₽ | 7% | 30% |

**Правила:**
- level_number должен быть уникальным
- threshold_amount для уровня 1 всегда = 0
- Можно создавать любое количество уровней

### 4.4 Таблица loyalty_transactions

**Назначение:** Полная история всех операций с бонусами.

**Поля:**

| Поле | Тип | Описание |
|------|-----|----------|
| id | BIGINT | Первичный ключ |
| user_id | INT | ID пользователя |
| order_id | INT | ID заказа (NULL для автоначислений) |
| type | ENUM | Тип операции |
| amount | INT | Сумма бонусов (целое число) |
| earned_at | DATETIME | Дата начисления |
| expires_at | DATETIME | Дата истечения |
| status | ENUM | pending/completed/cancelled |
| cancels_transaction_id | BIGINT | ID отменяемой транзакции |
| description | VARCHAR(500) | Описание |
| metadata | JSON | Дополнительные данные |
| created_at | DATETIME | Дата создания |
| updated_at | DATETIME | Дата обновления |

**Типы операций (type):**
- earn - Начисление за заказ
- spend - Списание при заказе
- refund_earn - Отмена начисления
- refund_spend - Возврат списанных
- expire - Истечение срока
- register_bonus - Бонус за регистрацию
- birthday_bonus - Бонус за ДР

**Статусы (status):**
- pending - Резервирование (временное)
- completed - Выполнено
- cancelled - Отменено

**Индексы:**
- PRIMARY KEY (id)
- INDEX (user_id, status)
- INDEX (user_id, expires_at, status) - для FIFO
- INDEX (order_id)
- INDEX (type, status)
- INDEX (created_at)

**Правила:**
- amount положительный для начислений, отрицательный для списаний
- earned_at и expires_at копируются при списании
- Все бонусы - целые числа

### 4.5 Таблица user_loyalty_levels

**Назначение:** История изменения уровней пользователей.

**Поля:**

| Поле | Тип | Описание |
|------|-----|----------|
| id | BIGINT | Первичный ключ |
| user_id | INT | ID пользователя |
| level_id | INT | ID уровня |
| reason | ENUM | initial/threshold_reached/degradation |
| triggered_by_order_id | INT | ID заказа-инициатора |
| total_spent_amount | INT | Сумма на момент изменения |
| started_at | DATETIME | Дата начала действия |
| ended_at | DATETIME | Дата окончания (NULL = текущий) |
| created_at | DATETIME | Дата создания |

**Индексы:**
- PRIMARY KEY (id)
- INDEX (user_id, ended_at)
- INDEX (user_id, started_at, ended_at)
- INDEX (level_id)

**Правила:**
- Одна запись с ended_at = NULL (текущий уровень)
- При смене закрывается старая, создается новая

### 4.6 Таблица user_loyalty_stats

**Назначение:** Денормализованная статистика для скорости.

**Поля:**

| Поле | Тип | Описание |
|------|-----|----------|
| user_id | INT | Первичный ключ |
| bonus_balance | INT | Текущий баланс |
| total_spent_60_days | INT | Сумма заказов за 60 дней |
| total_spent_all_time | INT | Сумма всех заказов |
| last_order_at | DATETIME | Дата последнего заказа |
| last_level_check_at | DATETIME | Дата проверки уровня |
| last_balance_reconciliation_at | DATETIME | Дата сверки баланса |
| total_earned | INT | Всего начислено |
| total_spent | INT | Всего потрачено |
| total_expired | INT | Всего сгорело |
| updated_at | DATETIME | Дата обновления |

**Назначение полей:**
- bonus_balance - для быстрого доступа (кеш 1 мин)
- total_spent_60_days - для определения уровня
- last_order_at - для проверки неактивности
- Счетчики - для статистики и отчетов

**Правила:**
- Обновляется при каждой операции
- Периодически сверяется с транзакциями

### 4.7 Изменения в таблице users

**Добавляемые поля:**

| Поле | Тип | Описание |
|------|-----|----------|
| current_loyalty_level_id | INT | Текущий уровень |
| loyalty_registered_at | DATETIME | Дата включения в программу |
| registration_bonus_granted | BOOLEAN | Выдан ли рег. бонус |
| birthday_bonus_last_granted_year | INT | Год последнего бонуса за ДР |

**Индексы:**
- INDEX (current_loyalty_level_id)
- INDEX (birth_date)

### 4.8 Таблица loyalty_logs

**Назначение:** Логирование событий и ошибок.

**Поля:**

| Поле | Тип | Описание |
|------|-----|----------|
| id | BIGINT | Первичный ключ |
| event_type | ENUM | Тип события |
| severity | ENUM | info/warning/error/critical |
| user_id | INT | ID пользователя |
| order_id | INT | ID заказа |
| transaction_id | BIGINT | ID транзакции |
| message | TEXT | Сообщение |
| details | JSON | Детали в JSON |
| created_at | DATETIME | Дата события |

**Типы событий:**
- balance_mismatch - Расхождение баланса
- duplicate_transaction - Дубликат
- cron_execution - Выполнение задачи
- error - Ошибка
- race_condition - Race condition

**Индексы:**
- PRIMARY KEY (id)
- INDEX (event_type)
- INDEX (severity)
- INDEX (user_id)
- INDEX (created_at)

---

## 5. Бизнес-правила и логика

### 5.1 Начисление бонусов

**Условия:**
- Программа включена
- Пользователь имеет уровень
- Заказ в статусе "Доставлен"/"Выдан"
- Бонусы еще не начислялись

**Расчет суммы:**

```
Шаг 1: Берем сумму заказа
сумма = order.total_amount

Шаг 2: Вычитаем использованные бонусы (если настройка включена)
если calculate_from_amount_after_bonus = true:
    сумма = сумма - order.bonus_used

Шаг 3: Вычитаем доставку (если настройка отключена)
если include_delivery_in_earn = false:
    сумма = сумма - order.delivery_cost

Шаг 4: Проверяем результат
если сумма <= 0:
    не начисляем бонусы
```

**Расчет бонусов:**

```
процент = текущий_уровень.earn_percent
бонусы = floor(сумма × процент / 100)
```

**Пример:**
- Заказ: 1000₽
- Доставка: 200₽
- Использовано: 300₽
- Уровень: Серебро (5%)

```
сумма = 1000 - 300 - 200 = 500₽
бонусы = floor(500 × 5 / 100) = 25
```

**Создание транзакции:**
- type = earn
- status = completed
- earned_at = NOW
- expires_at = NOW + 60 дней
- Обновление баланса

### 5.2 Списание бонусов

**Условия:**
- Программа включена
- Пользователь имеет уровень
- Достаточно бонусов
- Не превышен лимит

**Расчет максимума:**

```
Шаг 1: Сумма для расчета
если include_delivery_in_earn = false:
    сумма = order.total_amount - order.delivery_cost
иначе:
    сумма = order.total_amount

Шаг 2: Определение процента
процент = min(
    loyalty_settings.max_spend_percent,
    current_level.max_spend_percent
)

Шаг 3: Максимум
максимум = floor(сумма × процент / 100)

Шаг 4: Учет баланса
можно_списать = min(максимум, текущий_баланс)
```

**Пример:**
- Заказ: 2000₽
- Доставка: 300₽
- Баланс: 1000
- Уровень: Золото (30%)
- Системный лимит: 30%

```
сумма = 2000 - 300 = 1700₽
процент = min(30, 30) = 30%
максимум = floor(1700 × 30 / 100) = 510
можно_списать = min(510, 1000) = 510
```

**FIFO принцип:**

Алгоритм списания:
1. Получить все активные начисления
2. Сортировка по expires_at (ASC)
3. Для каждого:
   - Рассчитать доступный остаток
   - Списать максимум возможного
   - Перейти к следующему если не хватило

**Пример FIFO:**
Баланс:
- 100 бонусов → истекают через 5 дней
- 200 бонусов → истекают через 20 дней
- 300 бонусов → истекают через 40 дней

Списываем 250:
1. Берем 100 из первого (осталось 150 нужно)
2. Берем 150 из второго (готово)

Результат:
- Первое: 0 (потрачено полностью)
- Второе: 50 (осталось)
- Третье: 300 (не тронуто)

**Создание транзакций:**
- Может быть несколько (по одной на начисление)
- type = spend
- status = pending
- amount = отрицательный
- Копируются earned_at и expires_at

### 5.3 Отмена заказа

**Логика:**

1. Найти все транзакции по заказу
2. Для каждой создать обратную:
   - spend → refund_spend (+amount)
   - earn → refund_earn (-amount)
3. Оригиналы → status = cancelled
4. Обновить баланс

**Частичная отмена:**

При удалении позиций:
1. Отменить все транзакции
2. Пересчитать заново для новой суммы
3. Создать новые транзакции

### 5.4 Управление уровнями

**Повышение:**

Условия проверки:
- После каждого завершенного заказа
- В автоматической задаче ежедневно

Алгоритм:
1. Рассчитать сумму за 60 дней
2. Определить соответствующий уровень
3. Если изменился:
   - Закрыть текущий
   - Создать новый
   - Обновить пользователя

**Сумма за период:**

```
Выбрать заказы:
- status IN ('delivered', 'completed')
- created_at >= (NOW - 60 дней)

Для каждого:
    сумма_заказа = total_amount - bonus_used - delivery_cost

Итого = SUM(всех сумм)
```

**Определение уровня:**

```
Получить все активные уровни
Сортировать по threshold_amount (DESC)
Выбрать максимальный где:
    total_spent >= threshold_amount
```

**Момент применения:**

Если заказ инициировал повышение:
- Для этого заказа → старый процент
- Для следующих → новый процент

Если уровень обновился раньше:
- Для текущего → новый процент

**Понижение (деградация):**

Условия:
- Включена деградация
- Нет заказов > 180 дней
- Уровень > 1

Алгоритм:
1. Найти неактивных
2. Понизить на 1 уровень
3. Записать в историю

Правила:
- Только на 1 уровень за раз
- Золото → Серебро → Бронза

### 5.5 Истечение бонусов

**Автоматический процесс:**

Ежедневно в 00:00:
1. Найти начисления с expires_at <= NOW
2. Для каждого:
   - Рассчитать остаток
   - Создать транзакцию expire
   - Обновить баланс

**Отображение:**

В Mini App показывается:
- Бонусы истекающие в ближайшие 7 дней
- Для каждого: сумма + дата + дней осталось

### 5.6 Автоматические начисления

**Регистрация:**

При первой авторизации:
- Проверка флага registration_bonus_granted
- Если false:
  - Начислить 1000 бонусов
  - Срок 30 дней
  - Установить флаг = true

**День рождения:**

За 3 дня до ДР:
- Автоматическая задача в 06:00
- Находит именинников
- Проверяет год последнего начисления
- Начисляет 500 бонусов
- Срок: ДР + 7 дней (всего 11 дней)

---

## 6. Сценарии использования

### 6.1 Новый пользователь

**Этапы:**

1. **Регистрация:**
   - Передает номер телефона
   - Создается user

2. **Включение в программу:**
   - Присваивается уровень Бронза
   - Создается запись в user_loyalty_levels
   - Создается user_loyalty_stats
   - loyalty_registered_at = NOW

3. **Бонус за регистрацию:**
   - Начисление 1000 бонусов
   - Срок 30 дней
   - registration_bonus_granted = true

**Результат:**
- Уровень: Бронза
- Баланс: 1000 бонусов

### 6.2 Заказ с использованием бонусов

**Исходное состояние:**
- Уровень: Серебро
- Баланс: 500 (300 истекают через 10 дней, 200 через 40 дней)

**Оформление:**
1. Товары: 2000₽
2. Доставка: 200₽
3. Максимум списания: 450
4. Пользователь выбирает: 400

**Списание FIFO:**
1. 300 из первого начисления
2. 100 из второго начисления
3. Баланс: 100

**Завершение:**
1. Заказ доставлен
2. Списание: pending → completed
3. Начисление: 70 бонусов (5% от 1400₽)
4. Баланс: 170

### 6.3 Отмена заказа

**Заказ отменяется:**
- Списано: 300 (pending)
- Статус: в процессе

**Действия:**
1. Найти транзакцию spend
2. Создать refund_spend (+300)
3. Оригинал → cancelled
4. Баланс: +300

### 6.4 Повышение уровня

**Исходное:**
- Уровень: Бронза
- Сумма за 60 дней: 9500₽

**Новый заказ:**
- Сумма: 800₽
- Итого: 10300₽ ≥ 10000₽

**Повышение:**
1. Проверка после завершения
2. Закрытие Бронзы
3. Создание Серебра
4. reason = threshold_reached

**Начисление:**
- Используется старый процент (3%)
- 24 бонуса

**Следующие заказы:**
- Новый процент (5%)

### 6.5 День рождения

**25 января:**
- ДР пользователя: 28 января
- За 3 дня запускается задача

**Начисление:**
- 500 бонусов
- Действуют: 25.01 - 04.02
- birthday_bonus_last_granted_year = 2025

**В 2026:**
- Процесс повторится

### 6.6 Деградация

**Исходное:**
- Уровень: Золото
- Последний заказ: 200 дней назад

**Автоматическая задача:**
1. Проверка: 200 > 180
2. Понижение: Золото → Серебро
3. reason = degradation

**Через 180 дней без заказов:**
- Еще одно понижение: Серебро → Бронза

---

## 7. Настройки системы

### 7.1 Глобальные настройки

Все в таблице loyalty_settings, доступны в админке.

**Основные:**
- Программа включена: Да/Нет
- Максимальное списание: 30%

**Начисление:**
- Учитывать доставку: Нет
- От суммы после вычета бонусов: Да

**Уровни:**
- Период расчета: 60 дней
- Учитывать доставку: Нет
- Деградация включена: Да
- Период деградации: 180 дней

**Регистрация:**
- Включено: Да
- Сумма: 1000
- Срок: 30 дней

**День рождения:**
- Включено: Да
- Сумма: 500
- За сколько дней: 3
- Срок после: 7 дней

**Срок бонусов:**
- Обычные: 60 дней

### 7.2 Настройка уровней

Для каждого уровня:
- Название
- Порядковый номер
- Порог достижения
- Процент начисления
- Максимальное списание
- Активен/неактивен

**Возможности:**
- Создание любого количества
- Изменение условий
- Временное отключение
- Удаление (если нет пользователей)

---

## 8. Административные функции

### 8.1 Просмотр пользователя

**Информация:**
- Текущий баланс и уровень
- Процент начисления/списания
- Статистика (начислено/потрачено/истекло)
- Сумма за 60 дней
- Скоро истекающие бонусы

**История:**
- Все транзакции с фильтрами
- История уровней с датами и причинами

### 8.2 Инструменты аудита

**Поиск дублей:**
- Находит множественные начисления/списания по заказу
- Показывает детали каждого дубля

**Расхождения балансов:**
- Сравнивает сохраненный и рассчитанный
- Показывает разницу
- Автоматическое исправление

**Проблемные транзакции:**
- Pending более 24 часов
- Без связанного заказа
- Некорректные даты

### 8.3 Логи

**Типы событий:**
- Расхождения
- Дубликаты
- Выполнение задач
- Ошибки
- Race conditions

**Фильтрация:**
- По типу
- По серьезности
- По пользователю
- По периоду

---

## 9. Интеграция с заказами

### 9.1 Жизненный цикл

| Статус | Действие |
|--------|----------|
| Создан | Списание (pending) |
| В процессе | Бонусы pending |
| Доставлен | pending → completed + начисление |
| Отменен | Возврат всех бонусов |

### 9.2 Использование в заказе

**Расчет:**
1. Показать баланс
2. Рассчитать максимум
3. Валидация ввода
4. Применение FIFO

**Отображение:**
```
Товары:              2000₽
Доставка:             200₽
Промежуточный:       2200₽

Бонусы:         -400 бонусов
                     -------
К оплате:            1800₽
```

---

## 10. Автоматические процессы

### 10.1 График

| Время | Задача | Описание |
|-------|--------|----------|
| 00:00 | Истечение | Списание просроченных |
| 01:00 | Деградация | Понижение неактивных |
| 02:00 | Пересчет | Проверка уровней |
| 03:00 | Сверка | Проверка балансов |
| 06:00 | ДР бонусы | Начисление именинникам |

### 10.2 Истечение бонусов

**Алгоритм:**
1. Найти expires_at <= NOW
2. Для каждого рассчитать остаток
3. Создать транзакцию expire
4. Обновить баланс
5. Логирование

**Обработка:** Батчами по 100

### 10.3 Деградация уровней

**Алгоритм:**
1. Найти last_order_at < 180 дней
2. Фильтр: level > 1
3. Понизить на 1 уровень
4. Записать в историю
5. Логирование

**Обработка:** Батчами по 100

### 10.4 Пересчет уровней

**Алгоритм:**
1. Для всех пользователей с уровнем
2. Рассчитать сумму за 60 дней
3. Определить соответствующий уровень
4. При несоответствии - изменить
5. Логирование

**Обработка:** Батчами по 100

### 10.5 Сверка балансов

**Алгоритм:**
1. Для каждого пользователя
2. Рассчитать из транзакций
3. Сравнить с сохраненным
4. При расхождении:
   - Создать лог
   - Исправить баланс
5. Итоговый отчет

**Обработка:** Батчами по 100

### 10.6 Бонусы за ДР

**Алгоритм:**
1. Рассчитать дату (NOW + 3 дня)
2. Найти пользователей с ДР
3. Проверить год последнего начисления
4. Начислить 500 бонусов
5. Обновить год
6. Логирование

---

## 11. Отчетность и аудит

### 11.1 Отчеты

**Распределение по уровням:**
- Количество на каждом
- Процентное соотношение
- Динамика изменений

**Статистика бонусов:**
- Начислено за период
- Списано за период
- Истекло за период
- Средний/медианный баланс

**Эффективность:**
- % заказов с бонусами
- Средний % использования
- Конверсия регистрация → заказ
- Retention по уровням

### 11.2 Экспорт

**Транзакции:**
- Фильтры: период, пользователь, тип
- Формат: CSV, Excel
- Все поля + связанные данные

**Балансы:**
- Все пользователи с балансами
- Текущий уровень
- Статистика
- Формат: CSV, Excel

**Логи:**
- Фильтры: тип, серьезность, период
- Формат: CSV, JSON

### 11.3 Отладка

**Проверка пользователя:**
- Пересчет баланса в реальном времени
- Сравнение с сохраненным
- Список активных бонусов
- Проверка соответствия уровню

**Симуляция:**
- Предпросмотр списания (FIFO)
- Расчет без применения

**Ручная корректировка:**
- Пересчет баланса
- Пересчет уровня
- Исправление всех проблем

---

## 12. План доработки

### 12.1 Этапы (12-14 дней)

**Этап 1: Подготовка (1 день)**
- Backup БД
- Создание таблиц
- Добавление полей
- Индексы и ключи

**Этап 2: Миграция (2-3 дня)**
- Настройки
- Уровни
- Пользователи
- Транзакции
- Статистика

**Этап 3: Пересчет (1 день)**
- Балансы из транзакций
- Статистика пользователей
- Суммы для уровней
- Корректировка уровней
- Валидация

**Этап 4: Доработка кода (3-4 дня)**
- Рефакторинг начисления/списания
- FIFO логика
- Race conditions защита
- Обработка отмен
- Управление уровнями
- Автоначисления

**Этап 5: Автоматизация (1-2 дня)**
- Настройка cron
- Истечение
- Деградация
- Пересчет и сверка
- ДР бонусы
- Логирование

**Этап 6: Админка (2-3 дня)**
- Настройки системы
- Управление уровнями
- Просмотр пользователя
- Аудит
- Логи
- Отчеты

**Этап 7: Тестирование (2-3 дня)**
- Функциональное
- Граничные случаи
- Нагрузочное
- Race conditions
- FIFO
- Все сценарии

**Этап 8: Запуск (1 день)**
- Финальная проверка
- Включение
- Мониторинг
- Исправление критичных

### 12.2 Приоритеты

**P1 (Критично):**
1. Защита от дублей
2. Race conditions
3. Обработка отмен
4. FIFO

**P2 (Важно):**
5. Управление уровнями
6. Деградация
7. Истечение
8. Автоначисления

**P3 (Желательно):**
9. Сверка
10. Аудит
11. Админка
12. Отчеты

### 12.3 Критерии готовности

**Технические:**
- ✅ Таблицы созданы
- ✅ Данные мигрированы
- ✅ Балансы сверены
- ✅ Race conditions работает
- ✅ FIFO работает
- ✅ Cron настроен
- ✅ Логирование работает
- ✅ Кеш настроен

**Функциональные:**
- ✅ Начисление без дублей
- ✅ Списание корректное
- ✅ Отмена возвращает
- ✅ Частичная отмена работает
- ✅ Повышение работает
- ✅ Деградация работает
- ✅ Истечение работает
- ✅ Автоначисления работают
- ✅ Сверка работает

**Административные:**
- ✅ Все настройки доступны
- ✅ Управление уровнями
- ✅ Просмотр данных
- ✅ Аудит работает
- ✅ Логи доступны

### 12.4 Риски

**Потеря данных:**
- Вероятность: Низкая
- Митигация: Полный backup, поэтапная миграция, тесты

**Расхождения балансов:**
- Вероятность: Средняя
- Митигация: Ежедневная сверка, автоисправление, алерты

**Производительность:**
- Вероятность: Средняя
- Митигация: Индексы, кеш, батчи, мониторинг

**Баги в логике:**
- Вероятность: Средняя
- Митигация: Тестирование, постепенный запуск, откат, логи

### 12.5 Тестирование

**Модульное:**
- Расчет начисления
- Расчет максимума
- FIFO логика
- Определение уровня
- Даты истечения

**Интеграционное:**
- Полный цикл заказа
- Отмена на этапах
- Повышение через заказ
- Автозадачи
- API

**Сценарное:**
- Новый пользователь
- Активный пользователь
- Повышение уровней
- Деградация
- День рождения
- Истечение

**Нагрузочное:**
- Одновременные заказы
- Одновременное списание
- Массовое истечение
- Сверка большой базы

**Граничные случаи:**
- Баланс = 0
- Списание всего
- Минимальные суммы
- Только доставка
- Множественные отмены

---

## 13. Приложения

### 13.1 Глоссарий

**Бонус** - виртуальная валюта (1 бонус = 1₽)

**Начисление** - добавление бонусов

**Списание** - вычитание бонусов

**Уровень** - категория с привилегиями

**Порог** - сумма для перехода

**Деградация** - понижение при неактивности

**FIFO** - First In First Out (первый пришел - первый ушел)

**Race condition** - одновременное изменение

**Транзакция БД** - атомарная операция

**Блокировка** - предотвращение доступа

**Денормализация** - дублирование для скорости

**Сверка** - проверка соответствия

### 13.2 Формулы

**Начисление:**
```
сумма = total - bonus_used - delivery
бонусы = floor(сумма × процент / 100)
```

**Максимум списания:**
```
сумма = total - delivery
процент = min(системный, уровня)
максимум = floor(сумма × процент / 100)
можно = min(максимум, баланс)
```

**Сумма для уровня:**
```
сумма = SUM(заказы за 60 дней)
для каждого: total - bonus_used - delivery
```

### 13.3 FAQ

**Q: Что при отключении программы?**
A: Перестают начисляться/списываться, балансы сохраняются.

**Q: Можно изменить срок начисленных?**
A: Нет, только для новых.

**Q: Несколько порогов сразу?**
A: Присваивается максимальный.

**Q: Понизить вручную?**
A: Нет, только автоматически.

**Q: Дробные бонусы?**
A: Нет, округление вниз.

**Q: Отмена несколько раз?**
A: Создаются новые обратные транзакции.

**Q: Бонусы на доставку?**
A: Да, если настройка включена.

**Q: Как часто обновляется баланс?**
A: Немедленно, кеш 1 минута.

**Q: Нет активных бонусов?**
A: Ошибка, можно оформить без бонусов.

**Q: Подарить бонусы?**
A: Нет, в текущей версии.

### 13.4 KPI

**Вовлеченность:**
- % с активным балансом
- Средний баланс
- % заказов с бонусами

**Retention:**
- Rate по уровням
- LTV по уровням
- Частота по уровням

**Конверсия:**
- Регистрация → заказ
- Бронза → Серебро
- Серебро → Золото

**Экономика:**
- Средняя скидка
- % от выручки
- ROI программы

**Операционные:**
- Ошибок в день
- Расхождений
- Время cron

---

## Заключение

Данная документация описывает полную доработку существующего модуля системы лояльности. Основные направления:

1. Устранение критических багов
2. Повышение надежности
3. Добавление гибкости
4. Автоматизация процессов
5. Инструменты аудита

После внедрения система будет:
- Стабильно работать без ошибок
- Полностью управляться через админку
- Автоматически обслуживать себя
- Предоставлять инструменты анализа

Ожидаемый срок реализации: 12-14 дней

---

**Версия:** 1.0  
**Дата:** 24.01.2025  
**Статус:** Готово к реализации