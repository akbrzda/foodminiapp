# Тезисный отчет по анализу проекта FoodMiniApp

**Дата анализа:** 2024  
**Версия проекта:** Текущая (MVP)

---

## 1. ЧТО ХВАТАЕТ (Реализовано)

### 1.1 Backend
- ✅ Базовая архитектура Express.js сервера
- ✅ Подключение к MySQL и Redis
- ✅ WebSocket сервер для real-time обновлений
- ✅ Система аутентификации (JWT, Telegram)
- ✅ API для пользователей (регистрация, профиль, адреса)
- ✅ API для городов и филиалов
- ✅ API для меню (категории, позиции, модификаторы)
- ✅ API для заказов (создание, получение, изменение статуса)
- ✅ API для бонусной программы (баланс, история, начисление/списание)
- ✅ API для полигонов доставки (PostGIS, проверка зон)
- ✅ API для админ-панели (заказы, статистика)
- ✅ Система логирования (Winston, admin_logs)
- ✅ Очереди задач (BullMQ для синхронизации)
- ✅ Синхронизация с внешней системой "Гуляш"

### 1.2 База данных
- ✅ Полная схема БД с основными таблицами
- ✅ PostGIS поддержка для полигонов доставки
- ✅ Индексы для оптимизации
- ✅ Таблицы для логов и аудита

### 1.3 Telegram Mini App
- ✅ Базовая структура Vue 3 приложения
- ✅ Интеграция Telegram SDK
- ✅ Роутинг (Home, Menu, Cart, Profile, Orders)
- ✅ Авторизация через Telegram
- ✅ Выбор города и филиала
- ✅ Отображение меню
- ✅ Корзина
- ✅ Оформление заказа (доставка/самовывоз)
- ✅ Работа с адресами доставки
- ✅ История заказов
- ✅ Профиль пользователя
- ✅ Pinia stores (auth, cart, location, menu, telegram)

### 1.4 Инфраструктура
- ✅ Docker Compose конфигурация
- ✅ MySQL и Redis контейнеры
- ✅ Миграции БД

---

## 2. ЧЕГО НЕ ХВАТАЕТ (Критично для MVP)

### 2.1 Backend
- ❌ **Варианты позиций (item_variants)** — отсутствует в БД и API
  - В roadmap указано: "Одна позиция может иметь несколько вариантов с разными ценами"
  - Текущая реализация: только одна цена на позицию
  - Необходимо: таблица `item_variants`, API для работы с вариантами

- ❌ **Группы модификаторов (modifier_groups)** — отсутствует в БД и API
  - В roadmap указано: модификаторы группируются (группа → модификаторы)
  - Текущая реализация: модификаторы привязаны напрямую к позициям
  - Необходимо: таблицы `modifier_groups` и `item_modifier_groups`, API для групп

- ❌ **API геокодирования через Nominatim** — отсутствует
  - В roadmap указано: POST /api/geocode для геокодирования адресов
  - Текущая реализация: нет эндпоинта для геокодирования

- ❌ **Обработка изображений** — отсутствует worker
  - В roadmap указано: queue:images для оптимизации изображений
  - Текущая реализация: только queue:sync, нет обработки изображений

- ❌ **Telegram уведомления worker** — отсутствует
  - В roadmap указано: TelegramWorker для уведомлений о заказах
  - Текущая реализация: нет отдельного worker для Telegram уведомлений

- ❌ **API мониторинга очередей** — отсутствует
  - В roadmap указано: GET /api/admin/queues для статистики очередей
  - Текущая реализация: нет эндпоинтов для мониторинга

- ❌ **Программа лояльности: автоматическое повышение уровня** — не реализовано
  - В roadmap указано: LoyaltyService.checkLevelUp() для автоматического повышения
  - Текущая реализация: нет логики повышения уровня при достижении порога

- ❌ **Расчет стоимости доставки из полигона** — не реализовано
  - В коде: TODO комментарий "получить стоимость доставки из полигона"
  - Необходимо: использовать delivery_cost из delivery_polygons

### 2.2 База данных
- ❌ **Таблица item_variants** — отсутствует
- ❌ **Таблица modifier_groups** — отсутствует
- ❌ **Таблица modifiers** (отдельная от menu_modifiers) — отсутствует
- ❌ **Таблица item_modifier_groups** (связь позиций и групп) — отсутствует
- ❌ **Таблица loyalty_transactions** — отсутствует (есть только bonus_history)
- ❌ **Поле loyalty_level в users** — отсутствует
- ❌ **Поле total_spent в users** — отсутствует (для расчета уровня)

### 2.3 Telegram Mini App
- ❌ **Варианты позиций в UI** — не реализовано
  - Нет выбора варианта (Маленькая/Средняя/Большая пицца)
  - Нет отображения "цена от" для позиций с вариантами

- ❌ **Группы модификаторов в UI** — не реализовано
  - Нет группировки модификаторов (обязательные/опциональные)
  - Нет отображения типа группы (одиночный/множественный выбор)

- ❌ **Применение бонусов при оформлении** — не реализовано в UI
  - Нет toggle для применения бонусов
  - Нет отображения максимальной суммы к списанию (50%)

- ❌ **Прогресс-бар до следующего уровня** — не реализовано
  - Нет отображения прогресса до Серебра/Золота

- ❌ **WebSocket интеграция** — не реализовано
  - Нет подключения к WebSocket для real-time обновлений статуса заказа

- ❌ **Поиск по меню** — не реализовано
  - В roadmap указано, но в коде нет

- ❌ **Повтор заказа** — частично реализовано
  - Есть кнопка, но нужно проверить функциональность

### 2.4 Админ-панель
- ❌ **Админ-панель полностью отсутствует**
  - В roadmap указано: отдельный Vue 3 проект для админки
  - Текущая реализация: только backend API, нет фронтенда
  - Необходимо создать: admin-panel проект

- ❌ **Все функции админ-панели из roadmap не реализованы:**
  - Управление заказами (список, фильтры, изменение статуса)
  - Управление клиентами
  - Управление меню (категории, позиции, модификаторы)
  - Управление городами и филиалами
  - Полигоны доставки (Leaflet.js карта)
  - Аналитика и отчеты
  - Управление пользователями панели
  - Логи и аудит (UI)

---

## 3. ЧТО УБРАТЬ (Избыточное/Ненужное)

### 3.1 Backend
- ⚠️ **Синхронизация с "Гуляш"** — возможно избыточно для MVP
  - Если это не критично для запуска, можно отложить
  - Усложняет архитектуру (очереди, retry логика)

### 3.2 База данных
- ⚠️ **Поля gulyash_*** в таблицах** — если синхронизация не нужна
  - gulyash_client_id, gulyash_city_id, gulyash_order_id и т.д.
  - Можно оставить для будущего, но не использовать сейчас

### 3.3 Общее
- ⚠️ **Сложная логика retry в очередях** — упростить для MVP
  - Текущая реализация: 3 попытки с экспоненциальной задержкой
  - Для MVP можно упростить до 1-2 попыток

---

## 4. ЧТО ДОБАВИТЬ (Приоритетно)

### 4.1 Критично для MVP (Этап 1)

#### Backend
1. **Добавить таблицы для вариантов позиций:**
   ```sql
   CREATE TABLE item_variants (
     id INT PRIMARY KEY,
     item_id INT,
     name VARCHAR(100), -- "Маленькая (25см)"
     price DECIMAL(10, 2),
     sort_order INT
   );
   ```

2. **Добавить таблицы для групп модификаторов:**
   ```sql
   CREATE TABLE modifier_groups (
     id INT PRIMARY KEY,
     name VARCHAR(100),
     type ENUM('single', 'multiple'),
     is_required BOOLEAN
   );
   
   CREATE TABLE modifiers (
     id INT PRIMARY KEY,
     group_id INT,
     name VARCHAR(100),
     price DECIMAL(10, 2)
   );
   
   CREATE TABLE item_modifier_groups (
     item_id INT,
     modifier_group_id INT
   );
   ```

3. **Добавить поля в users для программы лояльности:**
   ```sql
   ALTER TABLE users ADD COLUMN loyalty_level INT DEFAULT 1;
   ALTER TABLE users ADD COLUMN total_spent DECIMAL(10, 2) DEFAULT 0.00;
   ```

4. **Реализовать API для вариантов позиций:**
   - GET /api/menu/items/:id/variants
   - POST /api/admin/menu/items/:id/variants
   - PUT /api/admin/menu/variants/:id

5. **Реализовать API для групп модификаторов:**
   - GET /api/menu/modifier-groups
   - POST /api/admin/menu/modifier-groups
   - PUT /api/admin/menu/modifier-groups/:id

6. **Реализовать геокодирование:**
   - POST /api/geocode (Nominatim API)

7. **Реализовать автоматическое повышение уровня лояльности:**
   - При завершении заказа проверять total_spent
   - Автоматически повышать уровень при достижении порога

8. **Исправить расчет стоимости доставки:**
   - Использовать delivery_cost из delivery_polygons при создании заказа

#### Telegram Mini App
1. **Добавить выбор вариантов позиций в модальном окне товара**
2. **Добавить отображение групп модификаторов (обязательные/опциональные)**
3. **Добавить применение бонусов при оформлении заказа**
4. **Добавить прогресс-бар до следующего уровня лояльности**
5. **Добавить поиск по меню**
6. **Интегрировать WebSocket для real-time обновлений**

### 4.2 Важно для MVP (Этап 2)

#### Админ-панель
1. **Создать отдельный проект admin-panel (Vue 3 + Vite)**
2. **Реализовать базовую структуру:**
   - Авторизация администраторов
   - Боковое меню навигации
   - Главная панель

3. **Реализовать управление заказами:**
   - Список заказов с фильтрами
   - Карточка заказа
   - Изменение статуса
   - Real-time обновления (WebSocket)

4. **Реализовать управление меню:**
   - Категории (CRUD)
   - Позиции с вариантами (CRUD)
   - Группы модификаторов (CRUD)

5. **Реализовать полигоны доставки:**
   - Leaflet.js карта
   - Рисование полигонов (Leaflet.draw)
   - Редактирование/удаление

### 4.3 Опционально (Можно отложить)

1. **Обработка изображений worker** (queue:images)
2. **Telegram уведомления worker** (отдельный от sync)
3. **API мониторинга очередей**
4. **Расширенная аналитика** (графики, экспорт отчетов)
5. **Управление пользователями админ-панели** (CRUD)
6. **UI для логов и аудита** (есть API, нет UI)

---

## 5. РЕКОМЕНДАЦИИ

### 5.1 Приоритет разработки
1. **Сначала:** Варианты позиций и группы модификаторов (критично для функциональности)
2. **Затем:** Админ-панель (необходима для работы персонала)
3. **Потом:** Улучшения Mini App (бонусы, WebSocket, поиск)
4. **В конце:** Опциональные функции (обработка изображений, расширенная аналитика)

### 5.2 Технические замечания
- **PostGIS:** Убедиться, что MySQL контейнер поддерживает PostGIS (возможно нужен другой образ)
- **Nominatim API:** Реализовать rate limiting (1 req/sec) и кеширование
- **Варианты позиций:** Обязательны (нельзя создать позицию без варианта)
- **Максимум 3 полигона:** Валидировать на backend при создании

### 5.3 Архитектурные улучшения
- Вынести константы программы лояльности (пороги, проценты) в конфигурацию
- Добавить валидацию максимального количества полигонов на филиал
- Улучшить обработку ошибок в API (более детальные сообщения)

---

## 6. ИТОГОВАЯ ОЦЕНКА

### Реализовано: ~60% от MVP
- ✅ Backend API: ~70%
- ✅ База данных: ~80% (не хватает вариантов и групп)
- ✅ Telegram Mini App: ~65%
- ❌ Админ-панель: 0%

### Критичные пробелы:
1. Варианты позиций (item_variants) — **блокер**
2. Группы модификаторов (modifier_groups) — **блокер**
3. Админ-панель — **критично для работы**
4. Программа лояльности (автоповышение уровня) — **важно**

### Время до MVP: ~2-3 недели
- Варианты и группы: 3-4 дня
- Админ-панель: 5-7 дней
- Улучшения Mini App: 2-3 дня
- Тестирование и исправления: 2-3 дня

---

**Вывод:** Проект имеет хорошую базу, но для полноценного MVP необходимо реализовать варианты позиций, группы модификаторов и админ-панель. Текущая версия подходит для тестирования базового функционала, но не готова к продакшену.
