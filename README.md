# FoodMiniApp

## Описание

Система управления заказами и контентом для доставки еды. Состоит из backend API, админ‑панели и Telegram Mini App.

## Архитектура

- **Backend**: Node.js (Express), MySQL, Redis.
- **Admin panel**: Vue 3 + Vite.
- **Telegram miniapp**: Vue 3 + Vite.

## Основные модули

- **Заказы**: создание, статусы, начисление/списание бонусов.
- **Меню**: категории, позиции, модификаторы, теги, стоп‑лист.
- **Клиенты**: карточка клиента, история заказов и бонусов.
- **Доставка**: зоны доставки, города, филиалы.
- **Лояльность**: уровни, начисления, списания, автоматизация.
- **Администрирование**: пользователи админ‑панели, системные настройки, логи.

## Лояльность

### Ключевые правила

- Начисления зависят от уровня лояльности.
- Списание ограничено максимальным процентом.
- Бонусы имеют срок действия и списываются по FIFO.
- Уровни пересчитываются по сумме заказов за 60 дней.
- Автоматическое повышение и понижение уровней.

### Таблицы

- **loyalty_settings** — настройки лояльности.
- **loyalty_levels** — уровни и их условия.
- **loyalty_transactions** — транзакции начислений/списаний/возвратов.
- **user_loyalty_stats** — агрегированная статистика клиента.
- **user_loyalty_levels** — история смены уровней.
- **loyalty_logs** — аудит и системные события.
- **users** — поля `bonus_balance`, `current_loyalty_level_id` и связанные поля.

### Эндпоинты (backend)

**Настройки лояльности**

- `GET /api/loyalty-settings` — публичные настройки.
- `GET /api/loyalty-settings/admin` — административные настройки.
- `PUT /api/loyalty-settings/admin` — обновление настроек.

**Админ‑управление**

- `GET /api/admin/loyalty/levels` — список уровней.
- `POST /api/admin/loyalty/levels` — создание уровня.
- `PUT /api/admin/loyalty/levels/:id` — обновление уровня.
- `DELETE /api/admin/loyalty/levels/:id` — удаление уровня.
- `GET /api/admin/loyalty/logs` — логи лояльности.
- `GET /api/admin/loyalty/audit/duplicates` — аудит дублей.
- `GET /api/admin/loyalty/audit/mismatches` — аудит расхождений.
- `GET /api/admin/loyalty/users/:id/stats` — статистика клиента.
- `GET /api/admin/loyalty/users/:id/levels` — история уровней клиента.

### Автоматические процессы

- **bonusExpiry** — истечение бонусов.
- **levelRecalc** — пересчет уровней.
- **levelDegradation** — понижение уровней.
- **balanceReconcile** — сверка балансов.
- **birthdayBonus** — бонус ко дню рождения.

### Админ‑интерфейс

- **LoyaltyAdmin**: уровни, настройки, логи и аудит.
- **ClientDetail**: статистика лояльности клиента и история уровней.

> Примечание: проценты в админке вводятся целыми числами (например, 5 = 5%).
